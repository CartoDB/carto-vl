<!DOCTYPE html>
<html>

<head>
  <title>Centroids | CARTO VL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <script src="../dist/carto-vl.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
      center: [-87.69990112331521, 41.84453868528371],
      zoom: 0,
    });

    map.on('load', () => {
      //fetch('/test/common/sources/points.geojson')
      fetch('/test/common/sources/polygon-collection-with-multipolygon.geojson')
        .then(response => response.json())
        .then(function (polygons) {

          const field = 'name'; // points --> 'cat' | polygons --> 'name'

          const source = new carto.source.GeoJSON(polygons);
          const viz = new carto.Viz(`
            @field: $${field}
            @v_features: viewportFeatures(@field)
            color: ramp(@field, prism)
            width: 15
          `);
          const layer = new carto.Layer('original', source, viz);
          layer.addTo(map, 'watername_ocean');

          let created = false;
          layer.on('updated', () => {
            const polygons = viz.variables.v_features.value;

            if (!created && polygons.length > 0) {
              addLayerWithCentroidsFrom(polygons);
              created = true;
            }

            function addLayerWithCentroidsFrom(features) {
              const geojsonFeatures = features.map(f => {
                return {
                  "type": "Feature",
                  "geometry": {
                    "type": "Point",
                    "coordinates": f.getCenter()
                  },
                  "properties": {
                    "field": f.properties[field]
                  }
                }
              });

              const sourceCentroids = new carto.source.GeoJSON({
                type: 'FeatureCollection',
                features: geojsonFeatures
              });
              const centroids = new carto.Layer('centroids', sourceCentroids,
                new carto.Viz(`
                  symbol: cross
                  color: red
                  width: 20
                  symbolPlacement: ALIGN_CENTER
                `)
              );
              centroids.addTo(map);
            }
          });



        });
    });


  </script>
</body>

</html>
