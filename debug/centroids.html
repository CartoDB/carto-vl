<!DOCTYPE html>
<html>

<head>
  <title>Centroids | CARTO VL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <script src="../dist/carto-vl.js"></script>
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
      center: [0, 0],
      zoom: 0,
      renderWorldCopies: false
    });
    const nav = new mapboxgl.NavigationControl();
    map.addControl(nav, 'top-left');

    // const URL = '/test/common/sources/point-collection.geojson'; // points
    // const URL = '/test/common/sources/line-string.geojson'; // lines
    const URL = '/test/common/sources/polygon-collection-with-multipolygon.geojson'; // polygons
    // const URL = 'https://cartovl.carto.com/api/v2/sql?format=GeoJSON&q=SELECT *, name as cat FROM world_borders'; // complex polygons

    let centroidsLayer;
    map.on('load', () => {
      fetch(URL)
        .then(response => response.json())
        .then(function (geojson) {
          const FIELD = 'cat'; // the field to style with
          const source = new carto.source.GeoJSON(geojson);
          const viz = new carto.Viz(`
            @field: $${FIELD}
            @v_features: viewportFeatures(@field)
            color: opacity(ramp(@field, prism), 0.6)
            width: 15
          `);

          const layer = new carto.Layer('original', source, viz);
          layer.addTo(map, 'watername_ocean');

          function updateCentroidsLayer() {
            const originalFeatures = viz.variables.v_features.value;

            function sourceFrom(features) {
              const centroidFeatures = features.map(f => {
                return {
                  "type": "Feature",
                  "geometry": {
                    "type": "Point",
                    "coordinates": f.getCentroid()
                  },
                  "properties": {
                    "field": f.properties[FIELD]
                  }
                }
              });
              const sourceCentroids = new carto.source.GeoJSON({
                type: 'FeatureCollection',
                features: centroidFeatures
              });
              return sourceCentroids;
            }

            const updatedSource = sourceFrom(originalFeatures);

            // updated with every change
            if (centroidsLayer) {
              centroidsLayer.update(updatedSource);
              console.log('updated centroids');
              return;
            }

            // created just once
            centroidsLayer = new carto.Layer('centroids', updatedSource,
              new carto.Viz(`
                  symbol: cross
                  color: red
                  width: 20
                  symbolPlacement: ALIGN_CENTER
                `)
            );
            centroidsLayer.addTo(map);
            console.log('centroid layer created');
          };

          layer.on('updated', updateCentroidsLayer);
        });
    });


  </script>
</body>

</html>
