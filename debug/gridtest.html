<!DOCTYPE html>
<html>

<head>
  <title>RASTER GRIDS | CARTO VL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <script src="../dist/carto-vl.js"></script>
  <script src='https://libs.cartocdn.com/mapbox-gl/v0.48.0-carto1/mapbox-gl.js'></script>
  <link href='https://libs.cartocdn.com/mapbox-gl/v0.48.0-carto1/mapbox-gl.css' rel='stylesheet' />
  <script src="https://unpkg.com/geotiff@latest/dist/geotiff.bundle.min.js"></script>

  <link href='../examples/style.css' rel='stylesheet' />

  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <aside class="toolbox">
    <div class="box">
      <header>
        <h1>Color expressions</h1>
      </header>
      <section>
        <div id="controls">
          <ul>
            <li>
              <label>
                <input type="button" name="style" onclick="prevExpr()" checked>
                Prev</label>
            </li>
            <li>
              <label>
                <input type="button" name="style" onclick="nextExpr()">
                Next</label>
            </li>
          </ul>
        </div>
      </section>
      <footer class="js-footer"></footer>
    </div>
  </aside>

  <script>
    const map = new mapboxgl.Map({
      container: 'map',
      style: carto.basemaps.voyager,
      center: [20, 35],
      zoom: 3,
      dragRotate: true
    });

    carto.setDefaultAuth({
      user: 'cartovl',
      apiKey: 'default_public'
    });

    function genBand(width, height, fn) {
        const band = new Float32Array(width*height);
        for (let i=0; i<width; ++i) {
            for (let j=0; j<height; ++j) {
                band[i + j*width] = fn(i, j);
            }
        }
        return band;
    }

    function genGrid(x0, y0, x1, y1, width, height, srid) {
        bands = [];
        const i0 = Math.floor(width/2);
        const j0 = Math.floor(height/2);
        const max = 100.0
        bands.push(genBand(width, height, (i, j) => {
          // Band0: Saddle
          const x = (i - i0)/i0;
          const y = (j - j0)/j0;
          return max*((Math.pow(x,3)-3*x*Math.pow(y,2))/4+0.5);
        }));
        const r = Math.min(width,height)*3/4;
        bands.push(genBand(width, height, (i, j) => {
          // Band1: Mountain
          const x = (i - i0)*2/r;
          const y = (j - j0)*2/r;
          return max*(Math.exp(-Math.pow(x,2)-Math.pow(y,2)));
        }));
        bands.push(genBand(width, height, (i, j) => {
          // Band2: Ramp
          return max*(i/width + j/height)/2;
        }));
        const n = 20; // pixels per stripe/square
        bands.push(genBand(width, height, (i, j) => {
          // Band3: stripes
          return Math.floor(j/n) % 2;
        }));
        bands.push(genBand(width, height, (i, j) => {
          // Band4: checkboard
          return (Math.floor(i/n) % 2) ^ (Math.floor(j/n) % 2);
        }));

        return {
          data: bands,
          bbox: [x0, y0, x1, y1],
          width: width,
          height: height,
          srid
        };
    }

    const DEG2RAD = Math.PI / 180;
    const EARTH_RADIUS = 6378137;

    function projectToWebMercator (latLng) {
        let lat = latLng.lat * DEG2RAD;
        let lng = latLng.lng * DEG2RAD;
        return {
            x: lng * EARTH_RADIUS,
            y: Math.log(Math.tan(lat / 2 + Math.PI / 4)) * EARTH_RADIUS
        };
    }

    const expressions = [
        'hsv($band0/100, $band1/100, $band2/100 + 0*$band3 + 0*$band4)',
        'hsv($band0/100, 1, $band1/100)',
        'hsv(1-$band0/100, 1, $band1/100)',
        'hsv($band0/100, 1, 1-$band1/100)',
        'hsv(1-$band0/100, 1, 1-$band1/100)',
        'hsv(0, 0, sqrt($band1/100))',
        'rgb((sqrt($band1/100)>0.5)*255, 255-$band2*255/100, $band2*255/100)',
        'rgb((sqrt($band1/100)>0.5)*255, 0, 0)',
        'rgb(0, 255-$band2*255/100, $band2*255/100)',
        'rgb($band4*255, 255-$band2*255/100, $band2*255/100)',
        'rgb((sqrt($band1/100)<0.5)*255,  255-$band2*255/100, $band2*255/100)',
        'rgb((sqrt($band1/100)<0.5)*255,  255-$band2*255/100*$band4, $band2*255/100)',
        'hsv(0, 0, sqrt($band1/100)>0.5)',
        'opacity(rgb((sqrt($band1/100))*255,  255-$band2*255/100, $band0*255/100*(1-$band1/100)),0.85)',
        'opacity(hsv(0,0,$band3),0.6)',
        'opacity(hsv(0,0,$band4),0.6)',
        'opacity(hsv(0,$band3,$band0),0.7)',
        'opacity(hsv(0,$band4,$band0),0.7)',
        'ramp(linear($band0, 0, 100), [#ffff00, #ff0000])',
        'ramp(linear($band0, 0, 100), [#FFFFAA, #AA0000])',
        'ramp(linear(100-$band2, 0, 100), [#FFFFAA, #AA0000])',
        'ramp(linear($band2, 0, 100), [#FFFFAA, #AA0000])',
        'ramp(linear($band1, 0, 100), [#FFFFAA, #AA0000])',
        'ramp(linear($band1, 0, 100), [#009955, #ffff00, #ff0000])',
        'ramp(linear($band1, 0, 100), [#0055AA, #009955, #ffff00, #ff0000])',
        'ramp(sqrt(linear($band1, 0, 100)), [#0055AA, #009955, #ffff00, #ff0000])'
    ];
    let currentExpr = 0;
    let vizg, vizgwm;

    map.on('load', () => {
        const sw = projectToWebMercator({ lng: -10, lat: 20 });
        const ne = projectToWebMercator({ lng: 10, lat: 50 });
        const gridwm = genGrid(sw.x, sw.y, ne.x, ne.y, 1000, 2000, 3857);
        const grid = genGrid(10, 20, 30, 50, 1000, 2000, 4326);

        const sourcegwm = new carto.source.Grid(gridwm)
        vizgwm = new carto.Viz(`color: ${expressions[currentExpr]}`);
        const layergwm = new carto.Layer('gridwm', sourcegwm, vizgwm);
        layergwm.addTo(map, 'watername_ocean');

        const sourceg = new carto.source.Grid(grid)
        vizg = new carto.Viz(`color: ${expressions[currentExpr]}`);
        const layerg = new carto.Layer('grid', sourceg, vizg);
        layerg.addTo(map, 'watername_ocean');
    });

    function mod(x, n) {
      while (x < 0) {
        x += n;
      }
      return x % n;
    }

    function setExpr(i) {
        currentExpr = mod(i, expressions.length);
        const expr = expressions[currentExpr];
        vizgwm.color.blendTo(expr);
        vizg.color.blendTo(expr);
        console.log(currentExpr, expr)
    }

    function nextExpr() {
        setExpr(currentExpr + 1);
    }
    function prevExpr() {
        setExpr(currentExpr - 1);
    }

  </script>
</body>

</html>
